<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/blacklab-internals.md at 2022-02-04
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20220204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>BlackLab Core &#x2013; BlackLab internals</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script type="text/javascript" src="./js/apache-maven-fluido-1.7.min.js"></script>
<link href='http://fonts.googleapis.com/css?family=Nunito:300' rel='stylesheet' type='text/css' />
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="http://www.ivdnt.org/" id="bannerLeft"><img src="images/logo_2_ivd-nt_transparant.png"  alt="Dutch Language Institute (INT)"/></a></div>
        <div class="pull-right"><a href="BlackLab/" id="bannerRight"><img src="images/logo-blacklab.png"  alt="BlackLab"/></a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
      <li class=""><a href="http://www.ivdnt.org/" class="externalLink" title="INT">INT</a><span class="divider">/</span></li>
      <li class=""><a href="index.html" title="BlackLab">BlackLab</a><span class="divider">/</span></li>
    <li class="active ">BlackLab internals</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2022-02-04</li>
          <li id="projectVersion" class="pull-right">Version: 2.2.0</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">BlackLab</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="learn.html" title="Learn"><span class="icon-chevron-down"></span>Learn</a>
    <ul class="nav nav-list">
    <li><a href="getting-started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="corpus-query-language.html" title="Corpus Query Language"><span class="none"></span>Corpus Query Language</a></li>
    <li><a href="blacklab-server-overview.html" title="BlackLab Server overview"><span class="none"></span>BlackLab Server overview</a></li>
    <li><a href="configuration-files.html" title="Configuration files"><span class="none"></span>Configuration files</a></li>
    <li><a href="blacklab-server-different-languages.html" title="Using BlackLab Server from different languages"><span class="none"></span>Using BlackLab Server from different languages</a></li>
    <li><a href="indexing-with-blacklab.html" title="Indexing with BlackLab"><span class="none"></span>Indexing with BlackLab</a></li>
    <li><a href="add-input-format.html" title="Add An Input Format"><span class="none"></span>Add An Input Format</a></li>
    <li><a href="improve-search-speed.html" title="Improve Search Speed"><span class="none"></span>Improve Search Speed</a></li>
    <li><a href="apidocs/index.html" title="API reference"><span class="none"></span>API reference</a></li>
    <li><a href="file-formats.html" title="File formats"><span class="none"></span>File formats</a></li>
    </ul>
</li>
    <li><a href="downloads.html" title="Downloads"><span class="none"></span>Downloads</a></li>
    <li><a href="faq.html" title="FAQ"><span class="none"></span>FAQ</a></li>
    <li><a href="changelog.html" title="Change Log"><span class="none"></span>Change Log</a></li>
    <li><a href="roadmap.html" title="Road Map"><span class="none"></span>Road Map</a></li>
    <li><a href="newsletter.html" title="Newsletter"><span class="none"></span>Newsletter</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>BlackLab internals</h1>
<p>Here we want to document how BlackLab works internally. At the moment it is still very much incomplete, but we intend to add and update information as time goes on.</p>
<div class="section">
<h2><a name="Module_structure"></a>Module structure</h2>
<p>BlackLab has been divided up into modules that serve specific functions. This is intended to make the structure and dependencies clearer, to make BlackLab easier to understand and make future improvements easier.</p>
<p>This the current list of modules:</p>
<table border="0" class="table table-striped">
<thead>

<tr class="a">
<th> Module          </th>
<th> Description                                                  </th></tr>
</thead><tbody>

<tr class="b">
<td> <tt>common</tt>          </td>
<td> classes used by a number of other modules. Currently only contains BlackLab-specific <tt>Exception</tt> subclasses.</td></tr>
<tr class="a">
<td> <tt>content-store</tt>   </td>
<td> responsible for storing the input documents indexed in BlackLab for later display with optional highlighting of hits. </td></tr>
<tr class="b">
<td> <tt>contrib/*</tt>       </td>
<td> some modules that serve specific functions that some projects may need, but many don&#x2019;t. Currently contains plugins to convert and tag input documents before indexing, as well as some legacy <tt>DocIndexer</tt> implementations. </td></tr>
<tr class="a">
<td> <tt>core</tt>            </td>
<td> will build the main BlackLab Java library. Doesn&#x2019;t contain any Java code itself but combines other modules (the main module is engine). </td></tr>
<tr class="b">
<td> <tt>engine</tt>          </td>
<td> implements most of the BlackLab functionality. </td></tr>
<tr class="a">
<td> <tt>instrumentation</tt> </td>
<td> two experimental modules for monitoring BlackLab Server using Prometheus or similar. </td></tr>
<tr class="b">
<td> <tt>interfaces</tt>      </td>
<td> was intended to contain interfaces shared between BlackLab modules, but currently empty. </td></tr>
<tr class="a">
<td> <tt>mocks</tt>           </td>
<td> mock objects useful for testing. Shouldn&#x2019;t be included in library build. </td></tr>
<tr class="b">
<td> <tt>query-parser</tt>    </td>
<td> the main Corpus Query Language parser (as well the more limited Contextual Query Language parser). </td></tr>
<tr class="a">
<td> <tt>server</tt>          </td>
<td> the BlackLab Server web service </td></tr>
<tr class="b">
<td> <tt>text-pattern</tt>    </td>
<td> the <tt>TextPattern</tt> classes that currently sit between the query parser and the <tt>SpanQuery</tt> classes. </td></tr>
</tbody>
</table>
<p>Future plans for this module structure:</p>
<ul>

<li><tt>common</tt> should probably not grow; rather shrink and ideally be eliminated altogether</li>
<li><tt>content-store</tt> should be made optional, so you can also use e.g. an external webservice to retrieve the document contents.</li>
<li><tt>engine</tt> currently does a lot, with a lot of interdependencies between classes, and could/should therefore be divided up into logical modules.</li>
<li><tt>interfaces</tt> should either be used for truly shared interfaces, or should be removed. Probably the latter as interfaces belong with the module providing the associated functionality.</li>
<li><tt>query-parser</tt> could be reduced to just the Corpus Query Language parser, with the Contextual Query Language parser moved into a <tt>contrib</tt> module.</li>
<li><tt>text-pattern</tt> could eventually become unnecessary as we move their functionality into the various <tt>SpanQuery</tt> classes, and could then be moved to <tt>contrib</tt> for legacy uses.</li>
</ul></div>
<div class="section">
<h2><a name="Important_classes_and_their_function"></a>Important classes and their function</h2>
<div class="section">
<h3><a name="Engine.2C_index"></a>Engine, index</h3>
<ul>

<li><tt>BlackLabEngine</tt> is the class that manages the BlackLab search threads. It has a <tt>searchExecutorService</tt> that search threads can be submitted to. The <tt>open</tt> and <tt>openForWriting</tt> methods can be used to open indexes.</li>
<li><tt>BlackLabIndex</tt> represents a single opened index. You can use it to search the index directly using methods like <tt>find(BLSpanQuery)</tt>, or you can construct a <tt>Search</tt> description using the <tt>search()</tt> methods and then either execute it synchronously using <tt>Search.execute()</tt> or go through the cache using <tt>Search.executeAsync()</tt>.</li>
</ul></div>
<div class="section">
<h3><a name="Search_results"></a>Search results</h3>
<ul>

<li><tt>SearchResult</tt> is the base interface that all types of results objects implement: <tt>Hits</tt> (and its subclasses like <tt>HitsFromQueryParallel</tt>), <tt>HitGroups</tt>, <tt>DocResults</tt>, <tt>Facets</tt>, etc.</li>
</ul></div>
<div class="section">
<h3><a name="Search_cache"></a>Search cache</h3>
<p>BlackLab features a cache system that can keep track of results of finished queries as well as currently running queries.</p>
<p>The idea is that users will often search for something that can benefit from having recent query results available. For example: paging back and forth through a result set; changing the sort for a result set; grouping a result set by some criterium.</p>
<p>The potential disadvantage of such a cache is that it can take up a lot of memory, starving other queries of memory.</p>
<p>The implementation of the cache is left up to the user of BlackLab. BlackLab Server, the webservice accompanying BlackLab, provides an implementation that can be configured in various ways (see <tt>BlsCache</tt> below).</p>
<div class="section">
<h4><a name="BlackLab_caching"></a>BlackLab caching</h4>
<p>These are the important interfaces and classes involved in BlackLab&#x2019;s cache system and BLS&#x2019;s implementation:</p>
<ul>

<li><tt>Search&lt;R extends SearchResult&gt;</tt> and its subclasses can be used to build complete descriptions of search requests (e.g. a query for hits, with optional sorting, grouping, etc.). It has <tt>execute()</tt> and <tt>executeAsync()</tt> methods that execute the search task described by the &#x201c;tree&#x201d; of <tt>Search</tt>es. The different classes rely on each other&#x2019;s functionality, so <tt>SearchHitsSorted</tt> gets a <tt>SearchHits</tt> as a parameter and will call its <tt>execute</tt> method before sorting the hits produced by that. <tt>Search&lt;R&gt;.executeAsync()</tt> calls <tt>SearchCache.getAsync(this)</tt>, which will return a <tt>SearchCacheEntry&lt;R extends SearchResult&gt;</tt> that either has already completed (i.e. the results are actually in the cache from before) or will be executed and produce its results when the <tt>SearchCacheEntry</tt> (a <tt>Future</tt>) completes (i.e. wasn&#x2019;t in the cache but is now and is being or will be executed).</li>
<li><tt>SearchCache</tt> is the interface that cache implementations must adhere to. Its main two methods are <tt>get()</tt> and <tt>getAsync()</tt>, which take a search (subclass of <tt>Search&lt;R extends SearchResult&gt;</tt>, where <tt>R</tt> is the type of <tt>SearchResult</tt> we expect from the search). <tt>get()</tt> will block until the result is available (either found in the cache or executed). <tt>getAsync()</tt> will not block but return a <tt>SearchCacheEntry&lt;R&gt;</tt>, that will eventually yield the desired results. The cache itself stores these <tt>SearchCacheEntry</tt>s, so you can retrieve the &#x201c;results&#x201d; of an ongoing search.</li>
</ul>
<p>NOTE: <tt>BlackLabEngine</tt>&#x2019;s <tt>searchExecutorService</tt> uses a standard <tt>Executors.newCachedThreadPool()</tt>. It has no maximum number of threads. Instead we limit the maximum number of <tt>BlsCacheEntry</tt>s that can be running at any one time. New <tt>BlsCacheEntry</tt>s submitted when we&#x2019;re already at the maximum number of running entries will be waiting to start (queued) until they can be executed. Note that only top-level searches (i.e. those requested by the user) can be queued; others will be started automatically right away. For example, if the user requests hits for <tt>cat</tt> grouped by metadata field <tt>author</tt>, that entire request may be queued. But when it is unqueued (i.e. started), both the hits request and the grouping of those hits are allowed to run. This way of queueing was chosen to prevent deadlocks when a required intermediate result is not available because it is queued and cannot be started until the waiting thread has finished.</p>
<p>NOTE: unless a custom <tt>SearchCache</tt> is configured (like BlackLab Server does), BlackLab uses a dummy cache that doesn&#x2019;t actually cache anything. So <tt>executeAsync()</tt> will block and return an already-completed <tt>SearchCacheEntry</tt>, effectively doing the same as <tt>execute()</tt>.</p></div>
<div class="section">
<h4><a name="BLS_cache_implementation"></a>BLS cache implementation</h4>
<p>BlackLab Server implements a custom cache to improve performance for users who might be paging through results, re-ordering results, going from hits to grouped hits, etc.</p>
<p>This works as follows:</p>
<ul>

<li><tt>BlsCache</tt> implements <tt>SearchCache</tt> that manages the cache based on the amount of free Java heap memory to strive for, how long a search has been running, how long since results have been accessed, etc. See the configuration of BlackLab Server for details.</li>
<li><tt>BlsCacheEntry&lt;T extends SearchResult&gt;</tt> represents an entry in the cache. As <tt>SearchCache</tt> requires, it implements <tt>SearchCacheEntry&lt;T extends SearchResult&gt;</tt>. It is returned from <tt>BlsCache.getAsync()</tt>.</li>
<li><tt>BlsCacheEntry</tt> submits a <tt>Runnable</tt> to <tt>BlackLabEngine</tt>&#x2019;s <tt>searchExecutorService</tt>.</li>
<li><tt>SpansReader</tt> is also a <tt>Runnable</tt> that is submitted to <tt>BlackLabEngine</tt>&#x2019;s <tt>searchExecutorService</tt>. Note that because <tt>SpansReader</tt> is not a <tt>BlsCacheEntry</tt>, we don&#x2019;t actually keep track of these as running searches for load management. It would be better to do this.</li>
</ul></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2022
<a href="https://www.ivdnt.org/">Instituut voor Nederlandse Taal (INT)</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
